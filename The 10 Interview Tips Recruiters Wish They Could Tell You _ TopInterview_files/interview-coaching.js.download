/** 
 * This script loads a TopInterview coaching Advertisement into an iframe.
 * To use, just load this script where you would want the Ad placed in the DOM
 * eg. <script data-key="<partner_key>" id="top-interview-widget" type="text/javascript" src="https://widgets.talentinc.com/top-interview/v1/interview-coaching.js"></script>
 * add data-ti-width="300" for a 300x250 ad, omit for a 720x100 ad
 * add data-ti-border="1" for a 1px black border around the ad, omit for no-border
 * add data-company-name="Google" if the job interview company name is known, omit if unknown
 * to stylize, wrap this script in a container div, eg. <div class="top_interview_ad_container"><script ...></script></div>
 */

// define the topinterview domain, and the calling domain  
var tiHostName = window.location.protocol+'//'+window.location.hostname;

// create an iframe element and load into onto the page
var tiIframe = document.createElement('iframe');
var ifrmNme = 'top-interview-iframe';
tiIframe.setAttribute('id', ifrmNme); // assign the id
tiIframe.setAttribute('class','ti-frame'); // add a class
tiIframe.setAttribute('sandbox','allow-forms allow-scripts allow-popups')
//console.log('tiHostName = '+tiHostName);

// find TI script element on the page
var tiScript = document.scripts.namedItem('top-interview-widget');
// get custom data passed-in
let coName = '';
if (tiScript.hasAttribute('data-company-name')) {
	coName = tiScript.getAttribute('data-company-name');
}
let pKey = '';
if (tiScript.hasAttribute('data-key')) {
	pKey = tiScript.getAttribute('data-key');
}
let tiWidth = "720";
if (tiScript.hasAttribute('data-ti-width')) {
	tiWidth = tiScript.getAttribute('data-ti-width');
}
let tiBorder = "border: 0;";
if (tiScript.hasAttribute('data-ti-border') && tiScript.getAttribute('data-ti-border') == "1") {
	tiBorder = "border: 1px solid black;";
}
// pull the domain for where this js was loaded
let srcUrl = tiScript.getAttribute('src');
let tiInd = srcUrl.indexOf('//');
let srcSub = srcUrl.substring(tiInd+2);
let tiInd2 = srcSub.indexOf('/');
let tiDomain = srcSub.substring(0,tiInd2);
// insert iframe before script element on the page
tiScript.parentNode.insertBefore(tiIframe, tiScript);
let tiFrameSrc = '//'+tiDomain+'/top-interview/v1/interview-coaching-iframe.php?tiWidth='+tiWidth+'&siteHostName='+encodeURI(tiHostName);
if (coName !== '') {
	// only add company name if it exists
	tiFrameSrc += "&companyName="+encodeURI(coName);
}
if (pKey !== '') {
	tiFrameSrc += '&partner_key='+encodeURI(pKey);
	// only load the iframe, if there is a partner key
	tiIframe.setAttribute('src', tiFrameSrc);
}
let tiHeight = '';
if (tiWidth == "720") {
	tiHeight = ' height: 100px;';
} else if (tiWidth == "300") {
	tiHeight = ' height: 250px;';
}
// add the iframe style to the page 
let tiIframeCss = '.ti-frame { width: 100%;	max-width:'+tiWidth+'px;'+tiHeight+' display: inline-block; border-width: 0px; border-style: none; '+tiBorder+'}';
let tiHead  = document.getElementsByTagName('head')[0];
let tiIfStyle  = document.createElement('style');
tiHead.appendChild(tiIfStyle);
tiIfStyle.type = 'text/css';
if (tiIfStyle.styleSheet){
	tiIfStyle.styleSheet.cssText = tiIframeCss;
} else {
	tiIfStyle.appendChild(document.createTextNode(tiIframeCss));
}

// set the iframe height 
function setTIFrameHeight(newHeight) {
	//console.log('changing height to '+ newHeight);
	let el = document.getElementById(ifrmNme);
	el.style.height = newHeight;
}

// handle messages from the iframe 
function handleIframeMessage(e) {
	//console.log('handleMessageFromIframe - tiHostName='+tiHostName);
	//console.log(e.origin);
	// use data to set a new height
	if (e.data.action == "setTopInterviewIFrameHeight") {
		setTIFrameHeight(e.data.newHeight);
	}
}

// listen to messages from the iframe
window.addEventListener('message', handleIframeMessage, false);

// post a message to the iframe
function postMsgToTIFrame(msg) {
	//console.log('postMsgToTIFrame');
	let ifwindow = tiIframe.contentWindow;
	ifwindow.postMessage(msg, '*');
}

// handle window resize events
function handleWindowResize() {
	//console.log('handleWindowResize - clientWidth= '+tiIframe.clientWidth);
	var msg = {
		"action": "resizeIframeHeight",
	};
	postMsgToTIFrame(msg);
}

// listen to window resize events
window.addEventListener('resize', function(e){handleWindowResize()}, false);
